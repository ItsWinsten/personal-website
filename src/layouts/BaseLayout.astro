---
export interface Props {
  title: string;
  description?: string;
  image?: string;
  breadcrumbs?: { name: string; url: string; clickable?: boolean }[];
}

const { title, description = "PhD researcher developing AI-driven test automation for cyber-physical systems. Research, projects & insights on machine learning and software engineering.", image, breadcrumbs } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

const generatedBreadcrumbs = breadcrumbs || (() => {
  const path = Astro.url.pathname.replace(base, '').replace(/\/$/, '');
  
  const segments = path.split('/').filter(Boolean);
  const crumbs: { name: string; url: string; clickable?: boolean }[] = [
    { name: 'home', url: base, clickable: true }
  ];
  
  let currentPath = base;
  segments.forEach((segment, index) => {
    currentPath += segment + '/';
    const name = segment.replace(/-/g, '_');
    crumbs.push({ name, url: currentPath, clickable: true });
  });
  
  return crumbs;
})();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <link rel="alternate icon" type="image/x-icon" href={`${base}favicon.ico`} />
    <meta name="generator" content={Astro.generator} />
    
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    
    <link rel="sitemap" href={`${base}sitemap-index.xml`} />
    
    <!-- Preload fonts -->
    <link rel="preload" href="/fonts/fira-code-v27-latin-regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/fira-code-v27-latin-600.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Preload profile image for LCP -->
    <link rel="preload" href="/profile.webp" as="image" fetchpriority="high" />
  </head>
  <body>
    <div class="container center">
      <header class="header">
        <div class="header__inner">
          <div class="header__logo">
            <a href={base}>
              <div class="logo">
                Winsten
              </div>
            </a>
          </div>
          <ul class="menu menu--mobile">
            <li class="menu__trigger">Menu ▾</li>
            <li>
              <ul class="menu__dropdown">
                <li><a href={`${base}research/`}>Research</a></li>
                <li><a href={`${base}projects/`}>Personal Projects</a></li>
              </ul>
            </li>
          </ul>
        </div>
        
        <nav class="navigation-menu">
          <ul class="navigation-menu__inner menu--desktop">
            <li><a href={`${base}research/`}>Research</a></li>
            <li><a href={`${base}projects/`}>Personal Projects</a></li>
          </ul>

          {generatedBreadcrumbs.length > 0 && (
            <nav class="breadcrumbs" aria-label="Breadcrumb">
              <ol class="breadcrumb-list">
                {generatedBreadcrumbs.map((crumb, index) => (
                  <li class="breadcrumb-item">
                    {index > 0 && (
                      <span class="breadcrumb-separator">/</span>
                    )}
                    {index === 0 && (
                      <span class="breadcrumb-separator">/</span>
                    )}
                    {crumb.clickable === false ? (
                      <span class="breadcrumb-root">{crumb.name}</span>
                    ) : index < generatedBreadcrumbs.length - 1 ? (
                      <a href={crumb.url}>{crumb.name}</a>
                    ) : (
                      <span class="breadcrumb-current">{crumb.name}</span>
                    )}
                  </li>
                ))}
              </ol>
            </nav>
          )}
        </nav>
      </header>
      
      <main class="content">
        <slot />
      </main>
      
      <footer class="footer">
        <div class="footer__inner">
          <div class="copyright">
            <span>© 2025 Jesper Winsten.</span>
            <span><a href="https://research.abo.fi/en/persons/jesper-winsten/">Research Profile</a></span>
            <span class="separator">::</span>
            <span><a href="https://github.com/ItsWinsten" target="_blank">GitHub</a></span>
            <span class="separator">::</span>
            <span><a href="https://fi.linkedin.com/in/jesper-winsten">Linkedin</a></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script>
      (() => {
        const container = document.querySelector(".container");
        const menus = document.querySelectorAll(".menu");
        
        document.body.addEventListener("click", () => {
          menus.forEach(menu => {
            if (menu.classList.contains("open")) {
              menu.classList.remove("open");
            }
          });
        });
        
        window.addEventListener("resize", () => {
          menus.forEach(menu => {
            menu.classList.remove("open");
          });
        });
        
        menus.forEach(menu => {
          const trigger = menu.querySelector(".menu__trigger");
          const dropdown = menu.querySelector(".menu__dropdown") as HTMLElement;
          
          if (trigger && dropdown && container) {
            trigger.addEventListener("click", event => {
              event.stopPropagation();
              
              if (menu.classList.contains("open")) {
                menu.classList.remove("open");
              } else {
                menus.forEach(m => m.classList.remove("open"));
                menu.classList.add("open");
              }
              
              if (dropdown.getBoundingClientRect().right > container.getBoundingClientRect().right) {
                dropdown.style.left = "auto";
                dropdown.style.right = "0";
              }
            });
            
            dropdown.addEventListener("click", e => e.stopPropagation());
          }
        });
      })();
    </script>
  </body>
</html>

<style is:global>
  @import "../styles/terminal.css";
  @import "../styles/fonts.css";
  @import "../styles/main.css";
  @import "../styles/header.css";
  @import "../styles/menu.css";
  @import "../styles/footer.css";
  @import "../styles/buttons.css";
  @import "../styles/page.css";
  @import "../styles/code.css";
  @import "../styles/syntax.css";
</style>
