---
import BaseLayout from '../layouts/BaseLayout.astro';

// Replace with your actual ORCID ID
const ORCID_ID = '0009-0009-4644-0072'; // e.g., '0000-0002-1234-5678'

interface OrcidWork {
  title: string;
  year: number;
  type: string;
  doi?: string;
  url?: string;
  journal?: string;
}

let publications: OrcidWork[] = [];
let fetchError: string | null = null;

// Fetch publications from ORCID
try {
  // First, get the works summary
  const response = await fetch(
    `https://pub.orcid.org/v3.0/${ORCID_ID}/works`,
    {
      headers: {
        'Accept': 'application/json',
      },
    }
  );

  if (response.ok) {
    const data = await response.json() as any;
    
    // Parse the ORCID response
    if (data.group) {
      publications = data.group.map((group: any) => {
        const workSummary = group['work-summary']?.[0];
        if (!workSummary) return null;

        const title = workSummary.title?.title?.value || 'Untitled';
        const year = workSummary['publication-date']?.year?.value || 'N/A';
        const type = workSummary.type || 'publication';
        
        // Get DOI or URL
        let doi = null;
        let url = null;
        
        if (workSummary['external-ids']?.['external-id']) {
          const externalIds = workSummary['external-ids']['external-id'];
          const doiEntry = externalIds.find((id: any) => id['external-id-type'] === 'doi');
          if (doiEntry) {
            doi = doiEntry['external-id-value'];
            url = `https://doi.org/${doi}`;
          }
        }
        
        // Get journal name if available
        const journal = workSummary['journal-title']?.value;

        return {
          title,
          year: parseInt(year) || 0,
          type,
          doi,
          url,
          journal,
        };
      }).filter(Boolean);

      // Sort by year (most recent first)
      publications.sort((a, b) => b.year - a.year);
    }
  } else {
    fetchError = `Failed to fetch from ORCID (Status: ${response.status})`;
  }
} catch (error) {
  fetchError = `Error fetching publications: ${error instanceof Error ? error.message : 'Unknown error'}`;
  console.error('ORCID fetch error:', error);
}
---

<BaseLayout title="Research">
  <div class="page">
    <h1>Research</h1>
    
    <h2>Research Interests</h2>
    <p>
      My research interests lie at the intersection of search-based software engineering, cyber-physical system testing, generative adversarial networks (GANs), and test automation.
    </p>

    <h2>Current Projects</h2>
    <p>
      [Describe your ongoing research projects]
    </p>
    
    <h2>Publications</h2>
    {fetchError && (
      <div class="notice">
        <p><strong>Note:</strong> {fetchError}</p>
        <p>Please update your ORCID ID in <code>src/pages/research.astro</code></p>
      </div>
    )}
    
    {publications.length > 0 ? (
      <div class="publications">
        {publications.map((pub) => (
          <div class="publication">
            <h3 class="pub-title">{pub.title}</h3>
            <div class="pub-meta">
              <span class="pub-year">{pub.year}</span>
              {pub.journal && <span class="pub-journal"> · {pub.journal}</span>}
              {pub.type && <span class="pub-type"> · {pub.type.replace(/-/g, ' ')}</span>}
            </div>
            {pub.url && (
              <div class="pub-links">
                <a href={pub.url} target="_blank" rel="noopener noreferrer">
                  View Publication →
                </a>
              </div>
            )}
          </div>
        ))}
      </div>
    ) : !fetchError && (
      <p><em>Loading publications from ORCID...</em></p>
    )}
    
    
    <h2>Research Links</h2>
    <p>
      Find my research profiles and publications on the following platforms:
    </p>
    <ul>
      <li><a href="https://research.abo.fi/en/persons/jesper-winsten/" target="_blank" rel="noopener noreferrer">Research Profile (Åbo Akademi)</a></li>
      <li><a href="https://orcid.org/YOUR-ORCID-ID" target="_blank" rel="noopener noreferrer">ORCID Profile</a></li>
      <li><a href="https://scholar.google.com/citations?user=YOUR-ID" target="_blank" rel="noopener noreferrer">Google Scholar</a></li>
      <li><a href="https://gitlab.com/YOUR-USERNAME" target="_blank" rel="noopener noreferrer">Work GitLab</a></li>
    </ul>
  </div>
</BaseLayout>

<style>
  .page {
    max-width: 760px;
    margin: 0 auto;
  }
  
  .page h2 {
    margin-top: 2rem;
  }
  
  .page ul {
    margin-left: 1.5rem;
  }

  .notice {
    background: var(--accent);
    padding: 1rem;
    border-radius: 4px;
    margin: 1rem 0;
  }

  .publications {
    margin-top: 1.5rem;
  }

  .publication {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--accent);
  }

  .publication:last-child {
    border-bottom: none;
  }

  .pub-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
    line-height: 1.4;
  }

  .pub-meta {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .pub-year {
    font-weight: bold;
  }

  .pub-type {
    text-transform: capitalize;
  }

  .pub-links {
    margin-top: 0.5rem;
  }

  .pub-links a {
    display: inline-block;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
  }

  .pub-links a:hover {
    text-decoration: underline;
  }
</style>
